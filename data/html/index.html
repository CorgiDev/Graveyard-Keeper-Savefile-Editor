<!DOCTYPE html>
<html>

<head>
    <script>
        window.resizeTo(800, 1000)
    </script>
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/materialize.min.js"></script>
    <script type="text/javascript" src="/eel.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8">
    <title>Graveyard Keeper Savefile Editor | Edit Savefile</title>
</head>

<body>
    <header></header>
    <main>
        <div class="con">
            <div class="loadingconwrap">
                <div class="loadingcon">
                    <div class="row">
                        <div>Loading the save file</div>
                    </div>
                    <div class="row">
                        <div class="progress">
                            <div class="indeterminate"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    <div class="loadingmask valign-wrapper" style="display: none;">
        <div class="loading">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-yellow">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-green">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer></footer>
    <script>
        // There is no intended right click behaviour, so let's disable it
        $(document).contextmenu(function (e) {
            e.preventDefault()
        })

        // Setup global variables
        let gamedata = {}
        let autocompletenames = {}
        let data = {};
        let error = false;
        let imageurls = {};

        // Load the data depending on the save file type
        async function getSaveFile(info) {
            if (info[0] == "slot") {
                data = await eel.getsavefile(info[2], info[1])();
            } else if (info[0] == "importjson") {
                data = await eel.getjsonsavefile(info[1])();
            } else if (info[0] == "importdat") {
                data = await eel.getcustomsavefile(info[1])();
            }

            // Display an error, should there be one
            if (data.hasOwnProperty("Error")) {
                $(".con").html(`<div class="intro error"><h3>The following error occured: ` + data["Error"] +
                    `</h3></div>`)
            } else {
                console.log(data)


                // When closing the save file editor, free memory
                window.addEventListener("beforeunload", function (e) {
                    eel.unloadsave(window.location.hash.split("#")[1].split("|")[1]);
                });

                // Load the data about items, so we know which ids are items, which are perks and so on
                fetch('/items.json')
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (json) {
                        gamedata = json;
                        // Generate the dictionaries used for the autocomplete
                        gamedata.items.forEach(i => {
                            autocompletenames[(data["locals"][i] || data["locals"][i.replace(/:\d$/g, "")]) + " (" + i + ")"] = null
                        })
                    });

                await applyData()
                generateEvents()
            }


        }

        // Create the HTML structure with the data we now have
        async function applyData() {
            // The base HTML of the form (values which you can edit directly and are not in a list)
            d =
                `
<div class="intro lesspadding">Generic:</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="row colorpoints">
            <div class="input-field col s4">
                <div class="gameicon i-red pre">
                    <img src="/rsc/Red_Tech_Symbol.png">
                </div>
                <input id="red" value="${data["r"]["cur"]}">
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-green pre">
                    <img src="/rsc/Green_Tech_Symbol.png">
                </div>
                <input id="green" value="${data["g"]["cur"]}">
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-blue pre">
                    <img src="/rsc/Blue_Tech_Symbol.png">
                </div>
                <input id="blue" value="${data["b"]["cur"]}">
            </div>
        </div>
        <div class="row money">
            <div class="input-field col s4">
                <div class="gameicon i-gold pre">
                    <img src="/rsc/Gold_Coin_Symbol.png">
                </div>
                <input id="gold" max="99" min="0" type="number" class="validate valid" value="${Math.floor(data["money"] % 10000 / 100)}">
                <span class="helper-text" data-error="Please input a number between 0 and 99" data-success="">Please input a number between 0 and 99</span>
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-silver pre">
                    <img src="/rsc/Silver_Coin_Symbol.png">
                </div>
                <input id="silver" max="99" min="0" type="number" class="validate valid" value="${Math.floor(data["money"] % 100)}">
                <span class="helper-text" data-error="Please input a number between 0 and 99" data-success="">Please input a number between 0 and 99</span>
            </div>
            <div class="input-field col s4">
                <div class="gameicon i-copper pre">
                    <img src="/rsc/Copper_Coin_Symbol.png">
                </div>
                <input id="copper" max="99" min="0" type="number" class="validate valid" value="${Math.round(data["money"]%1*100)}">
                <span class="helper-text" data-error="Please input a number between 0 and 99" data-success="">Please input a number between 0 and 99</span>
            </div>
        </div>
        <div class="row hpenergy">
            <div class="col s12">
                HP:
                <div class="input-field inline s8">
                    <input id="hp" type="number" class="validate valid" min="0" value="${data["hp"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>


            <div class="col s12 energy">Energy:
                <div class="input-field inline s8">
                    <input id="energy" type="number" class="validate valid" min="0" value="${data["energy"]["cur"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>
        </div>

        <div class="timecontainer">
            <div class="note"><b>WARNING:</b><br>Modify the time at your own risk. Don't forget NPC's walk to all events
            and they get triggered at certain positions at certain times - meaning if you change the time you can mess up their
            AI.<br>If you want to meet the merchant f.e. - set the day to Gluttony (the 3rd one) and change the Time to f.e.
            3:00 - this is because the change from morning to day leaves the merchant enough time to walk to the barn and also
            triggers his change of location in the morning. - if you would set it f.e. to 12:00 he wouldn't appear</div>
            <div class="col s12 energy">Current Day:
                <div class="input-field inline s8">
                    <input id="day" type="number" class="validate valid" min="0" value="${data["time"]["day"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>
        <div class="dayindicator col s12">
            <div class="day active"><img src="/rsc/pride.png"></div>
            <div class="day"><img src="/rsc/lust.png"></div>
            <div class="day"><img src="/rsc/gluttony.png"></div>
            <div class="day"><img src="/rsc/envy.png"></div>
            <div class="day"><img src="/rsc/wrath.png"></div>
            <div class="day"><img src="/rsc/sloth.png"></div>
        </div>
        <div class="timeofdayslider col s12">
            <p class="range-field">
                <input type="range" id="timeofday" min="0" max="24" step="0.25" />
            </p>
            <p class="timeoutput">24:00</p>
        </div>

        </div>

        <div class="row miscbuttons">
            <div class="btn deldrops col s6 offset-s3">Remove all Drops</div>
        </div>
    </form>
</div>
<div class="intro lesspadding">Inventory:
<br>
<div class="note">[Note: Only use qualities on items which have them and don't set no quality on items which have qualities, otherwise that will cause issues within the game.]</div>
</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="row">
            <div class="col s12">Inventorysize:
                <div class="input-field inline s8">
                    <input id="invsize" type="number" class="validate valid invsize" min="0" value="${data["inventory_size"]["cur"]}">
                    <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
                </div>
            </div>
        </div>
        <div class="items">
        </div>
        <p>Add Item:</p>
        <div class="item add">
            <div class="itemimage">
                <div class="itemquality"></div>
                <img src="/rsc/unknown_item.png">
            </div>
            <div class="iteminfo">
                <div class="itemname autocomplete">
                    <div class="input-field col s12">
                        <input type="text" class="autocomplete itemn">
                    </div>
                </div>
                <div class="itemmisc">
                    <div class="amount">
                        <div>Amount:</div>
                        <input type="number" value="1">
                    </div>
                    <div class="btncon">
                        <div class="btn repairbtn">Add</div>
                    </div>
                </div>
            </div>
        </div>
        <p>Equipped Items:</p>
<div class="note"><b>WARNING:</b><br>Change the item to a non tool item at your own risk.</div>
        <div class="equipped-items">
        </div>
    </form>
</div>
<div class="intro lesspadding">Additional Storages</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="additionalitems">
        </div>
    </form>
</div>
<div class="intro lesspadding">Relationships:
    <br>
    <div class="note">[Note: This may not work in some cases, because it does not modify the underlying quest values. I could also assume, that it gets reset after you do a specific quest.]</div>
</div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="relationships">
        </div>
    </form>
</div>
<div class="intro lesspadding">Perks:<br><div class="note">[Note: You can only view perks here. You get them through technologies so get yourself the red, green and blue points if you want to add more.]</div></div>
<div class="row">
    <form class="s10 col offset-s1 editsavedata">
        <div class="perks">
        </div>
    </form>
</div>
<div class="intro lesspadding">Save or Export:</div>
<div class="row savingcon">
    <div class="col s12"><div class="btn" id="overwrite">Save to saveslot (creates a backup)</div></div>
    <div class="col s12"><div class="btn" id="exportjson">Export to a .json file</div></div>
    <div class="col s12"><div class="btn" id="exportdat">Export to a .dat file</div></div>
</div>`
            // Replace the loading bar with our currently loaded data
            $(".con").html(d)

            // Hide the remove drops button of there are none
            if (data["drops"].length == 0) $(".deldrops").hide();

            // Show a loader because no events are applied to the buttons yet so the user knows he still has to wait
            $(".loadingmask").fadeIn(500);

            $("#timeofday").val((data.time.timeofday + 1) * 12);



            $('#timeofday').on("input", function () {

                let t = parseFloat($("#timeofday").val());
                $(".timeoutput").text(Math.floor(t) + ":" + Math.floor(t % 1 * 60));
                if($(".timeoutput").text().split(":")[1].length == 1) $(".timeoutput").text($(".timeoutput").text()+"0")

                data.time.timeofday = (t / 12)-1;
            });
            $("#timeofday").trigger("input")

            $("#day").on("input", function(){
                $(".day").removeClass("active");
                $($(".day")[(parseInt($("#day").val())-1) % 6]).addClass("active");
                data["time"]["day"] = parseInt($("#day").val());
            })

            $("#day").trigger("input");

            // Add the items in the inventory to the form
            for (let i = 0; i < data["inventory"].length; i++) {
                let it = data["inventory"][i];
                $(".items").append(await addItem(it["id"], it["amount"], it["durability"]));
            }

            // Add the items in tool section to the equipped inventory list (only allow repairs)
            for (let i = 0; i < data["subinventory"].length; i++) {
                let it = data["subinventory"][i];
                $(".equipped-items").append(await addItem(it["id"], it["amount"], it["durability"]));
            }

            // Add additional inventories
            for (let i = 0; i < data["additionalstorage"].length; i++) {
                await addInventory(data["additionalstorage"][i], i);
            }

            // Add relationships
            for (let i = 0; i < data["relationships"].length; i++) {
                await addRelationShip(data["relationships"][i]["v"].replace("_rel_", ""), data["relationships"][i][
                    "cur"
                ]);
            }

            // Add the current perks to the form
            for (let i = 0; i < data["perks"].length; i++) {
                await addPerk(data["perks"][i]["v"]);
            }


        }

        // For a specific inventory generate the preview images by copying every item icon and putting it as small version in a different container
        function createInventoryMiniPreview(index) {
            $("#inv" + index).parent().find(".inventoryminipreview").html("");
            $("#inv" + index).parent().find(".items img").clone().appendTo($("#inv" + index).parent().find(
                ".inventoryminipreview"));
        }

        // Add an additional storage to the list
        async function addInventory(inventory, index) {

            // The names of the possible id's
            let types = {
                "mf_box_stuff": "(Trunk)",
                "chest": "(Chest)",
                "rack_alchemy": "(Alchemy Rack)",
                "obj_church_scroll_cabinet": "(Scrollshelf)",
                "obj_church_bookcase": "(Bookshelf)",
                "rack_organs": "(Mortuary rack)",
            }
            let type = "";
            // If we have a name for it, we add it
            if (types.hasOwnProperty(inventory["type"])) type = types[inventory["type"]];
            // The base HTML for a single additional Inventory
            let inv =
                `
<div class="inventorycon">
<div class="invtinfo" id="inv${index}">Storage ${index+1} <div class="itemid">${type}</div></div>
<div class="inventoryminipreview"></div>
<div class="invt">
<!--After trying it seems inventory size for the storage units is hard coded, thats why we hide it--!>
<div class="row hide">
    <div class="col s12">Inventorysize:
        <div class="input-field inline s8">
            <input type="number" class="validate valid invsize" min="0" value="${inventory["size"]}">
            <span class="helper-text" data-error="Please input a number" data-success="">Please input a number</span>
        </div>
    </div>
</div>
<div class="items">
</div>
<p>Add Item:</p>
<div class="item add">
    <div class="itemimage">
        <div class="itemquality"></div>
        <img src="/rsc/unknown_item.png">
    </div>
    <div class="iteminfo">
        <div class="itemname autocomplete">
            <div class="input-field col s12">
                <input type="text" class="autocomplete itemn">
            </div>
        </div>
        <div class="itemmisc">
            <div class="amount">
                <div>Amount:</div>
                <input type="number" value="1">
            </div>
            <div class="btncon">
                <div class="btn repairbtn">Add</div>
            </div>
        </div>
    </div>
</div>
</div>
</div>`
            // Append this HTML to our container for additional storage inventories
            $(".additionalitems").append(inv);

            // Add every item to the inventory
            for (let i = 0; i < inventory["items"].length; i++) {
                $("#inv" + index).parent().find(".items").append(await addItem(inventory["items"][i]["id"], inventory[
                    "items"][i]["amount"], inventory["items"][i]["durability"]));
            }
            
            // Create a preview for that inventory (so it uses less page space)
            createInventoryMiniPreview(index);
        }

        // Turn a specific ID into a name
        // Here we have additional checks for item qualities
        function getLocalisation(id) {
            if (data["locals"].hasOwnProperty(id)) {
                return data["locals"][id];
            } else if (/:\d$/.test(id)) {
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ""))) return data["locals"][id.replace(/:\d$/, "")];
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ":1"))) return data["locals"][id.replace(/:\d$/,
                    ":1")];
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ":2"))) return data["locals"][id.replace(/:\d$/,
                    ":2")];
                if (data["locals"].hasOwnProperty(id.replace(/:\d$/, ":3"))) return data["locals"][id.replace(/:\d$/,
                    ":3")];
            } else {
                if (data["locals"].hasOwnProperty(id + ":1")) return data["locals"][id + ":1"];
                if (data["locals"].hasOwnProperty(id + ":2")) return data["locals"][id + ":2"];
                if (data["locals"].hasOwnProperty(id + ":3")) return data["locals"][id + ":3"];
            }
            return undefined;
        }

        // Get the url to the item icon by id
        async function getItemUrl(id) {

            if(imageurls.hasOwnProperty(id)){
                return imageurls[id];
            }

            // File names can't contain ":" thats why the files have "__" instead of ":" 
            let url = "/rsc/" + id.replace(/:/g, "__") + ".png"
            let t = await fetch(url)
            if (t.status == 404) {
                // If the file does not exist first check if it an item with a quality and then replace the quality with nothing
                if (/:\d$/.test(id)) {
                    let t2 = await fetch(url.replace(/__\d/, ""))
                    //If the file still doesn't exist use the unknown placeholder as icon
                    if (t2.status == 404) {
                        url = "/rsc/unknown_item.png"
                    } else {
                        url = url.replace(/__\d/, "");
                        imageurls[id] = url;
                    }
                } 
                // Check if the file is an organ and then try again with the base name
                else if (/_-?\d_-?\d/.test(id)) {
                    let t2 = await fetch(url.replace(/_-?\d_-?\d/, ""))
                    //If the file still doesn't exist use the unknown placeholder as icon
                    if (t2.status == 404) {
                        url = "/rsc/unknown_item.png"
                    } else {
                        url = url.replace(/_-?\d_-?\d/, "");
                        imageurls[id] = url;
                    }
                } else {
                    url = "/rsc/unknown_item.png"
                }
            }
            imageurls[id] = url;
            return url;
        }

        //Function to add a single item
        async function addItem(id, amount, durability) {
            //Check if we have a icon for the id, if not use default icon
            url = await getItemUrl(id);
            console.log(url)

            //Check for a quality of the item
            let spl = id.split(":");
            let quality = "";
            if (spl.length > 1) {
                let q = spl.slice(-1)[0];
                if (q == "1") {
                    quality = " copper";
                } else if (q == "2") {
                    quality = " silver";
                } else if (q == "3") {
                    quality = " gold";
                }
            }

            //If the item can be repaired, add a button to do that
            let button = ""
            if (durability != 1) {
                button = '<div class="btn repairbtn">Repair (' + Math.round(durability * 100) + '% left)</div>'
            }
            //HTML of a single item
            let item =
                `
<div class="item justadded${quality}">
    <div class="itemimage">
        <div class="itemquality"></div>
        <img src="${url}">
    </div>
    <div class="iteminfo">
        <div class="itemname">${getLocalisation(id)} <div class="itemid">(${id})</div></div>
        <div class="itemmisc">
            <div class="amount">
                <div>Amount:</div>
                <input type="number" value="${amount}">
            </div>
            <div class="btncon">
                ${button}
            </div>
        </div>
    </div>
    <div class="valign-wrapper">
        <div class="itemremove">x</div>
    </div>
</div>`
            return item;
        }

        //Function to add a single Perk to the list
        async function addPerk(id) {
            //Check if we have a icon for the id, if not use default icon
            let url = await getItemUrl(id);
            //If our localisation has it, add a description to the perk
            let description = (data["locals"].hasOwnProperty(id + "_d")) ? data["locals"][id + "_d"] : "";
            //HTML of a single perk
            let item =
                `
<div class="item justadded">
    <div class="itemimage">
        <img src="${url}">
    </div>
    <div class="iteminfo">
        <div class="itemname">${getLocalisation(id)} <div class="itemid">(${id})</div></div>
        <div class="itemmisc">
            <div class="amount">
                <div>${description}</div>
            </div>
        </div>
    </div>
</div>`
            $(".perks").append(item)
        }

        // Function to add a single Relationship to the list
        // Amount is the current friendliness
        async function addRelationShip(id, amount) {

            // Get the URL of the NPC
            let url = await getItemUrl(id);
            // HTML for a single Relationship
            let relationship =
                `
<div class="item justadded">
    <div class="npcimage">
        <img src="${url}">
    </div>
    <div class="iteminfo">
        <div class="itemname">${getLocalisation(id)}
            <div class="itemid">(${id})</div>
        </div>
        <div class="itemmisc">
            <div class="amount">
                <div class="gameicon i-friendship">
                    <img src="/rsc/Happiness_or_Friendship_Symbol.png">
                </div>
                <input type="number" class="validate valid" value="${amount}" max="100" min="0">
                <span class="helper-text" data-error="Please input a number between 0 and 99" data-success="">Please input a number between 0 and 99</span>
            </div>
        </div>
    </div>
</div>`
            // Add the HTML to the page
            $(".relationships").append(relationship)
        }

        // Bind events to the DOM after (most) content loaded
        function generateEvents() {

            // If we are not loading from a savefile, remove the save to saveslot button
            if (window.location.hash.split("#")[1].split("|").length < 3) {
                $("#overwrite").remove();
            }

            // Setup autocomplete for add item
            $('.add input.autocomplete.itemn').autocomplete({
                data: autocompletenames,
                minLength: 0,
                onAutocomplete: updateAddItemPreview
            });

            // Toggle the additional storage to either have the full view with the capability to edit or to just see the items as small icons
            $(".invtinfo").click(function () {
                $(this).parent().toggleClass("active");
            });

            // Bind functions to the add buttons
            $(".add:not(.perk) .btn.repairbtn").click(addItemButton);


            // Remove an item on click
            $(".items, .equipped-items").on("click", ".itemremove", function () {
                let e = $(this);

                // extract the id
                let id = e.parent().parent().find(".itemid").text().split("");
                id.shift();
                id.pop();
                id = id.join("");

                e.parent().parent().addClass("toremove");
                // Timed functions to have a CSS animation
                setTimeout(() => {
                    let index = e.parent().parent().index();
                    // Update the data in our array, so the relative positions of items stay the same
                    // We have 2 functions depending on if it is in the main inventory or in the inventory of an additional storage
                    // Additional storage
                    if (e.parents(".additionalitems").length > 0) {
                        let invindex = parseInt(
                            $(e).parents(".inventorycon").find(".invtinfo").attr("id").split("inv")[1]
                            )
                        data["additionalstorage"][invindex]["items"].splice(index, 1);
                        // Because items were removed we need to update the mini items preview
                        setTimeout(function () {
                            createInventoryMiniPreview(invindex)
                        }, 100);

                    }
                    //Sub Inventory
                    else if(e.parents(".equipped-items").length > 0) {
                        data["subinventory"].splice(index, 1)
                    }
                    // Own inventory
                    else data["inventory"].splice(index, 1)
                    // Remove the HTML from the DOM
                    e.parent().parent().remove();
                }, 520);
            });

            //Make item quality toggleable by keeping to click the icon
            $(".items, .item.add").on("click", ".itemquality", function () {
                let e = $(this);
                let item = e.parent().parent()

                // extract the id 
                let id;
                // The first in in the case of the field to add an item, because there we don't have an extra div which contains the id
                if (item.hasClass("add")) {
                    id = item.find(".itemname input").val().split("(").pop().split(")")[0];
                } else {
                    id = item.find(".itemid").text().split("");
                    id.shift();
                    id.pop();
                    id = id.join("");
                }

                // create the new id based on the old id (->copper->silver->gold->nothing->)
                let newid;
                if (item.hasClass("copper")) {
                    newid = id.replace(/:\d$/, ":2");
                    item.removeClass("copper");
                    item.addClass("silver");
                } else if (item.hasClass("silver")) {
                    newid = id.replace(/:\d$/, ":3");
                    item.removeClass("silver");
                    item.addClass("gold");
                } else if (item.hasClass("gold")) {
                    newid = id.replace(/:\d$/, "");
                    item.removeClass("gold");
                } else {
                    newid = id + ":1";
                    item.addClass("copper");
                }

                // Change the itemid (again depending on if normal item name or if currently a input field)
                if (item.hasClass("add")) {
                    console.log(id)
                    console.log(newid)
                    item.find(".itemname input").val(item.find(".itemname input").val().replace(id, newid));
                } else {
                    item.find(".itemid").text("(" + newid + ")");
                }



            });


            //Handle changing an item
            $(".items, .equipped-items").on("click", ".itemname:not('.curactive')", function () {
                let e = $(this).parent();
                $(this).addClass("curactive")
                $(this).html(
                    `
                <div class="input-field col s12 currentlyediting">
                    <input type="text" class="autocomplete itemn">
                </div>
                `
                )
                let x;

                // The function changing the data, when an autocomplete is selected
                let d = async function () {
                    let val = $(e).find("input").val();
                    console.log(val);
                    if (val.split("(").length > 1) {
                        // Get the item ID and URL
                        let id = val.split("(").pop().split(")")[0];
                        let url = await getItemUrl(id);

                        // Destroy the Autocomplete Object
                        M.Autocomplete.getInstance($(e).find(".itemname input")).destroy();

                        // Create new HTML
                        $(e).parent().find("img").attr("src", url);
                        $(e).find(".itemname").html(getLocalisation(id) + ' <div class="itemid">(' + id +
                            ')</div>');
                        $(e).find(".itemname").removeClass("curactive");
                    }

                };
                // The logic for the autocomplete
                $(this).find("input").autocomplete({
                    data: autocompletenames,
                    minLength: 0,
                    onAutocomplete: d
                });
            });

            // Repair logic --> set the durability to 1 on a broken item
            $(".items, .equipped-items").on("click", ".repairbtn", function () {
                let e = $($(this).parents()[3]);
                if (e.parents(".additionalitems").length > 0) {
                    let invindex = parseInt($(this).parents(".inventorycon").find(".invtinfo").attr("id").split(
                        "inv")[1])
                    data["additionalstorage"][invindex]["items"][e.index()]["durability"] = 1;
                } else if(e.parents(".equipped-items").length > 0) {
                    data["subinventory"][e.index()]["durability"] = 1;
                }
                else data["inventory"][e.index()]["durability"] = 1;
                e.find(".repairbtn").remove();

            });

            // Create the side menu with the sections for quicker navigation
            $("main").append('<div class="sidemenu"></div>');

            // Automatically extract the possible sections and the start letter and add the full name on hover
            let sections = $(".intro.lesspadding");
            for (let i = 0; i < sections.length; i++) {
                let s = $(sections[i]);
                let str = s.text().split(":")[0];
                $(".sidemenu").append("<div title=" + str + ">" + str[0].toUpperCase() + "</div>");
            }

            // Bind the event to scroll on click, we have to consider the zoom property, meaning we have to multiply by it, otherwise the offsets are wrong
            $(".sidemenu div").click(function () {
                $("html, body").animate({
                    scrollTop: $($(".intro.lesspadding")[$(this).index()])[0].offsetTop * parseFloat(
                        window.getComputedStyle(document.body).getPropertyValue("zoom"))
                }, 1000);
            })


            // Functions to initiate the saving the clicking the corresponding buttons
            $("#overwrite").click(function () {
                startSaving("slot");
            })

            $("#exportjson").click(function () {
                startSaving("json");
            })

            $("#exportdat").click(function () {
                startSaving("dat");
            })

            // Handle clicking the Delete Drops Button
            $(".deldrops").click(function () {

                // Generate an object with each item and the amount of them
                // But that amount is only item objects - a single item can have f.e. a stack size of 12 already
                let out = {};
                data.drops.map(e => {e = getLocalisation(e);out.hasOwnProperty(e) ? out[e]++ : out[e] = 1});

                // Display a warning
                let m = M.toast({html: `<div><p>Warning - this will remove ${data.drops.length} item(s) / group(s) from your game including:</p> ${Object.keys(out).map(e => {return out[e]+"x " + e}).join(", ")}</div><div class="confirm">Click here to confirm</div>`, displayLength: 1000000})
                $(m.el).find(".confirm").click(function() {
                    m.dismiss();
                    data.drops = [];

                    M.toast({html: "Removed drops successfully"});     

                    // Prevent the dialouge to fire again
                    $(".deldrops").addClass("disabled");
                    $(".deldrop").unbind("click");
                })
            })

            // Remove the loading circle so the user now knows he can use all the features.
            $(".loadingmask").fadeOut(500);

        }


        // Handle the different save types
        async function startSaving(type) {

            // Check if the user filled all fields and isn't currently editing an item name
            let t = canContinue();
            if (t === true) {
                // Update the data from the form which wasn't updated yet
                collectData();
                let hashdata = window.location.hash.split("#")[1].split("|");
                let b;
                // Call the different python save functions with the save hash
                if (type == "slot") {
                    b = await eel.saveslot(data, hashdata[1], hashdata[2])();
                } else if (type == "dat") {
                    b = await eel.savecustomsavefile(data, hashdata[1])();
                } else if (type == "json") {
                    b = await eel.savejsonsavefile(data, hashdata[1])();
                }
                
                // On error show error, else show success
                if (b.hasOwnProperty("Error")) {
                    M.toast({
                        html: "The following Error occured: " + b["Error"]
                    });
                } else {
                    M.toast({
                        html: "The operation succeeded"
                    });
                }
            } else {
                // Show message why the user can't continue
                M.toast({
                    html: t
                });
            }

        }


        // Handle the click on the Add Item Button
        async function addItemButton() {
            let container = $(this).parent().parent().parent().parent();
            let val = container.find("input").val();
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];
                if (gamedata["items"].indexOf(id) !== -1 && gamedata["items"].indexOf(id.replace(/:\d$/, ""))) {
                    amount = parseInt($(container.find("input")[1]).val());

                    // Check if own inventory or storage inventory
                    if ($(this).parents(".additionalitems").length > 0) {
                        let invindex = parseInt($(this).parents(".inventorycon").find(".invtinfo").attr("id").split(
                            "inv")[1])
                        // Check if the items don't exceed the inventory size
                        if (data["additionalstorage"][invindex]["items"].length < parseInt(container.parent().find(
                                ".invsize").val())) {
                            $("#inv" + invindex).parent().find(".items").append(await addItem(id, amount, 1));
                        } else {
                            M.toast({
                                html: "This storage unit only has " + container.parent().find(".invsize").val() +
                                    " spaces!"
                            });
                            return
                        }
                        
                        // Add item
                        data["additionalstorage"][invindex]["items"].push({
                            "amount": amount,
                            "id": id,
                            "durability": 1
                        });
                        
                        // Update the item preview
                        createInventoryMiniPreview(invindex);
                    } else {
                        // Check if the items don't exceed the inventory size
                        if (data["inventory"].length < parseInt(container.parent().find(".invsize").val())) {
                            $("form>.items").append(await addItem(id, amount, 1));
                        } else {
                            M.toast({
                                html: "Your inventory only has " + container.parent().find(".invsize").val() +
                                    " spaces!"
                            });
                            return
                        }

                        //Add the new item to the inventory variable
                        data["inventory"].push({
                            "amount": amount,
                            "id": id,
                            "durability": 1
                        })
                    }

                    return
                }
            }
            M.toast({
                html: "The given item does not exist!"
            });
        }

        //Handle the click on the Add Perk Button
        function addPerkButton() {
            let val = $(".item.add.perk input").val();
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];
                if (gamedata["perks"].indexOf(id) !== -1) {
                    // Check if the perk is already added
                    for (let i = 0; i < data["perks"].length; i++) {
                        if (data["perks"][i]["v"] == id) {
                            M.toast({
                                html: "You already have that perk!"
                            });
                            return
                        }
                    }
                    // Add the HTML of the perk
                    addPerk(id);
                    //Add the new perk to the perks variable
                    data["perks"].push({
                        "s": -1,
                        "v": id
                    })
                    return
                }
            }
            M.toast({
                html: "The given Perk does not exist!"
            });
        }

        // Function to update the item preview after change
        async function updateAddItemPreview() {
            console.log($(this.el))
            let val = $(this.el).val();
            console.log(val);
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];

                // Check if the quality changed
                let spl = id.split(":");
                if (spl.length > 1) {
                    let q = spl.slice(-1)[0];
                    if (q == "1") {
                        $(this.el).parents(".item").attr("class", "item add copper");
                    } else if (q == "2") {
                        $(this.el).parents(".item").attr("class", "item add silver");
                    } else if (q == "3") {
                        $(this.el).parents(".item").attr("class", "item add gold");
                    }
                } else {
                    $(this.el).parents(".item").attr("class", "item add");
                }

                // Update item icon url
                let url = await getItemUrl(id);
                $(this.el).parents(".item").find("img").attr("src", url);
            }
        }

        // Function to update the preview of a perk
        async function updateAddPerkPreview() {
            let val = $(".item.add.perk input").val()
            console.log(val)
            if (val.split("(").length > 1) {
                let id = val.split("(").pop().split(")")[0];
                let url = await getItemUrl(id);
                $(".item.add.perk img").attr("src", url)
                if (data["locals"].hasOwnProperty(id + "_d")) $(".item.add.perk .amount").text(data["locals"][id + "_d"])
                else $(".item.add.perk .amount").text("")
            }
        }

        // Update the data in our data object, which wasn't updated when the user was editing the values
        function collectData() {

            // Values which have their own field
            data["r"]["cur"] = parseInt($("#red").val());
            data["g"]["cur"] = parseInt($("#green").val());
            data["b"]["cur"] = parseInt($("#blue").val());
            data["money"] = parseInt($("#gold").val()) * 100 + parseInt($("#silver").val()) + parseInt($("#copper").val()) /
                100;
            data["hp"] = parseInt($("#hp").val());
            data["energy"]["cur"] = parseInt($("#energy").val());
            data["inventory_size"]["cur"] = parseInt($("#invsize").val());

            // Iterate the items of the own inventory
            let items = $("form>.items .item");
            for (let i = 0; i < items.length; i++) {
                data["inventory"][i]["amount"] = parseInt($(items[i]).find("input").val());
                data["inventory"][i]["id"] = $(items[i]).find(".itemid").text().replace(/\(|\)/g, "");
            }

            // Iterate the items of the subinventory
            items = $("form>.equipped-items .item");
            for (let i = 0; i < items.length; i++) {
                data["subinventory"][i]["id"] = $(items[i]).find(".itemid").text().replace(/\(|\)/g, "");
            }



            // Iterate all relationships
            let relationships = $(".relationships input")
            for (let i = 0; i < relationships.length; i++) {
                data["relationships"][i]["cur"] = parseInt($(relationships[i]).val());
            }

            // Iterate all additional storages and their items
            for (let i = 0; i < data["additionalstorage"].length; i++) {
                data["additionalstorage"]["size"] = parseInt($("#inv" + i).parent().find(".invsize").val());
                items = $("#inv" + i).parent().find(".items .item");
                for (let i2 = 0; i2 < items.length; i2++) {
                    data["additionalstorage"][i]["items"][i2]["amount"] = parseInt($(items[i2]).find("input").val());
                    data["additionalstorage"][i]["items"][i2]["id"] = $(items[i2]).find(".itemid").text().replace(
                        /\(|\)/g, "");
                }
            }
        }

        // Check if a item didn't autocomplete, so that the user doesn't save old ID's
        function canContinue() {
            if ($(".currentlyediting").length > 0) return "Please autocomplete all Items before saving";

            return true;
        }

        // Get the information of the save hash, save file type and possibly slot
        $(document).ready(function () {
            let info = window.location.hash.split("#")[1].split("|")
            getSaveFile(info);
        });
    </script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
</body>

</html>